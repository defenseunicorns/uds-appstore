# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/maru-runner/main/tasks.schema.json
includes:
  - test: tasks/test.yaml
  - lint: tasks/lint.yaml
  - setup: tasks/setup.yaml
  - build: tasks/build.yaml

variables:
  - name: REF
    description: "reference for the runtime image and zarf package"
    # x-release-please-start-version
    default: 0.0.0
    # x-release-please-end

tasks:
  - name: dev-ui
    description: "run the ui in dev mode"
    actions:
      - cmd: npx pnpm i && npm run dev
        dir: ui

  - name: dev-server
    description: "run the api server in dev mode (requires air https://github.com/air-verse/air?tab=readme-ov-file#installation)"
    actions:
      - cmd: go install github.com/air-verse/air@latest
      - cmd: air -c .air.toml

  - name: compile
    description: "compile the api server and ui outputting to build/"
    actions:
      - task: build:build-all

  - name: deploy-local
    description: "deploy the uds marketplace to a local cluster"
    actions:
      - task: build:build-local
      - cmd: uds zarf package deploy zarf-package-uds-marketplace-*-0.0.0.tar.zst --confirm
        dir: build

  - name: connect
    description: "forward the port to the uds marketplace cluster"
    actions:
      - cmd: kubectl -n uds-marketplace port-forward $(kubectl -n uds-marketplace get pods -o jsonpath='{.items[0].metadata.name}') 8080:8080

  - name: clean
    description: "clean the build directories"
    actions:
      - cmd: rm -rf build
      - cmd: rm -rf build
        dir: ui
      - cmd: rm -rf uds-core
        dir: .github
